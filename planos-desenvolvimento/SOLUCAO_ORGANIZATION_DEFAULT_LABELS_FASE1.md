# ‚úÖ Solu√ß√£o: Organization Default Labels - Fase 1 Completa

## üìä Status: **IMPLEMENTADO E FUNCIONAL**

Data: 3 de Outubro de 2025

---

## üéØ Objetivo
Criar um sistema de **Etiquetas Padr√£o da Organiza√ß√£o** que permite:
- Definir etiquetas padr√£o a n√≠vel de organiza√ß√£o
- Aplicar automaticamente estas etiquetas a novos boards
- Gerir estas etiquetas atrav√©s de uma interface de administra√ß√£o

---

## ‚úÖ Fase 1: Backend + Redux + UI B√°sica (COMPLETO)

### 1Ô∏è‚É£ Backend - Database & Models

#### Migration
- **Ficheiro**: `server/db/migrations/20251002000000_add_organization_default_labels.js`
- **Tabela**: `organization_default_label`
- **Campos**:
  - `id` (bigint, auto-gerado)
  - `name` (text, √∫nico case-insensitive)
  - `color` (text, validado contra cores do Label)
  - `description` (text, nullable)
  - `position` (integer, default 0)
  - `created_at` / `updated_at` (timestamps)
- **√çndices**:
  - `idx_org_default_label_position` (position)
  - `uq_org_default_label_name` (lower(name), unique)
- **Seeds**: 4 labels padr√£o (Aprovado, Rejeitado, Em Revis√£o, Precisa Trabalho)

#### Model
- **Ficheiro**: `server/api/models/OrganizationDefaultLabel.js`
- **Valida√ß√µes**:
  - `name`: required, maxLength 60
  - `color`: required, validado contra `Label.COLORS`
  - `description`: nullable, maxLength 280
  - `position`: defaultsTo 0

#### Query Methods
- **Ficheiro**: `server/api/hooks/query-methods/models/OrganizationDefaultLabel.js`
- **M√©todos**:
  - `getAll()` - retorna todas as labels ordenadas por position
  - `getOneById(id)` - busca por ID
  - `getOneByName(name)` - busca case-insensitive por nome
  - `createOne(values)` - cria nova label
  - `updateOne(id, values)` - atualiza label
  - `deleteOne(id)` - elimina label
  - `reorder(order)` - reordena m√∫ltiplas labels

### 2Ô∏è‚É£ Backend - Controllers & Helpers

#### Controllers
Todos em `server/api/controllers/organization-default-labels/`:
- `list.js` - GET `/api/organization-default-labels` - lista todas as labels
- `create.js` - POST `/api/organization-default-labels` - cria nova label
- `update.js` - PATCH `/api/organization-default-labels/:id` - atualiza label
- `delete.js` - DELETE `/api/organization-default-labels/:id` - elimina label
- `reorder.js` - POST `/api/organization-default-labels/reorder` - reordena labels
- `bulk-apply.js` - POST `/api/organization-default-labels/bulk-apply` - aplica a projetos existentes

**Autoriza√ß√£o**: Todos os controllers verificam `isAdminOrProjectOwner(req.currentUser)`

#### Helpers
- **`server/api/helpers/organization-default-labels/apply-to-boards.js`**
  - Aplica default labels a boards de um projeto
  - Suporta 3 modos: `skip`, `merge-by-name`, `rename-on-conflict`

#### Hook Modificado
- **`server/api/helpers/boards/create-one.js`**
  - Ao criar um novo board, aplica automaticamente as organization default labels
  - Guarded por feature flag (futuro)

#### Routes
- **`server/config/routes.js`**
```javascript
'GET /api/organization-default-labels': 'organization-default-labels/list',
'POST /api/organization-default-labels': 'organization-default-labels/create',
'PATCH /api/organization-default-labels/:id': 'organization-default-labels/update',
'DELETE /api/organization-default-labels/:id': 'organization-default-labels/delete',
'POST /api/organization-default-labels/reorder': 'organization-default-labels/reorder',
'POST /api/organization-default-labels/bulk-apply': 'organization-default-labels/bulk-apply',
```

### 3Ô∏è‚É£ Frontend - Redux

#### Action Types
- **`client/src/constants/ActionTypes.js`**
- 27 novos action types para fetch, create, update, delete, reorder, bulk apply + seus handlers

#### Actions
- **`client/src/actions/organization-default-labels.js`**
- Action creators para todas as opera√ß√µes

#### API Client
- **`client/src/api/organization-default-labels.js`**
- Fun√ß√µes que chamam o socket.io com headers de autoriza√ß√£o
- **IMPORTANTE**: Todos os m√©todos aceitam `headers` como √∫ltimo par√¢metro

#### Redux-ORM Model
- **`client/src/models/OrganizationDefaultLabel.js`**
- Model com campos: id, name, color, description, position, createdAt, updatedAt
- Reducer que processa actions de fetch, create, update, delete, reorder

#### Sagas
- **`client/src/sagas/organization-default-labels.js`**
- Sagas para todas as opera√ß√µes ass√≠ncronas
- **CR√çTICO**: Usa `request` wrapper para injetar Authorization header
- Registrado em `client/src/sagas/core/watchers/index.js`

### 4Ô∏è‚É£ Frontend - UI

#### Componente Principal
- **`client/src/components/common/AdministrationModal/DefaultLabelsPane/DefaultLabelsPane.jsx`**
- Tab no modal de Administra√ß√£o
- Mostra lista de labels padr√£o
- Usa `useMemo` para evitar re-renders desnecess√°rios

#### Estilos
- **`client/src/components/common/AdministrationModal/DefaultLabelsPane/DefaultLabelsPane.module.scss`**
- Tema "liquid glass" com `rgba` e `backdrop-filter`

#### Tradu√ß√µes
- **pt-PT** (`client/src/locales/pt-PT/core.js`):
  - `defaultLabels`: "Etiquetas Padr√£o"
  - `defaultLabelsDescription`: "Estas etiquetas s√£o automaticamente adicionadas a todos os novos boards."
  - `noDefaultLabelsYet`: "Ainda n√£o tem etiquetas padr√£o."
  - `addCommonLabelsForAllProjects`: "Adicione etiquetas comuns que deseja usar em todos os projetos."
- **en-US** (`client/src/locales/en-US/core.js`): equivalentes em ingl√™s

---

## üêõ Bugs Corrigidos Durante Implementa√ß√£o

### Bug 1: Migration - Unique Index com lower()
**Problema**: `table.unique(knex.raw('lower(name)'))` causava erro de sintaxe  
**Solu√ß√£o**: Usar `knex.raw('CREATE UNIQUE INDEX ...')` separadamente

### Bug 2: Model - Atributo `position` com `required` + `defaultsTo`
**Problema**: Sails.js n√£o permite ambos ao mesmo tempo  
**Solu√ß√£o**: Remover `required: true`, manter apenas `defaultsTo: 0`

### Bug 3: Model - Defini√ß√£o expl√≠cita de `id`
**Problema**: Sails.js exige `required` ou `autoIncrement` para `id`  
**Solu√ß√£o**: Remover completamente a defini√ß√£o de `id`, Sails.js gere automaticamente

### Bug 4: Frontend - Export default missing
**Problema**: `actions/organization-default-labels.js` n√£o tinha default export  
**Solu√ß√£o**: Adicionar `export default { ... }` com todas as fun√ß√µes

### Bug 5: Redux-ORM - Selector usando `.all()`
**Problema**: `OrganizationDefaultLabel.all()` n√£o funciona em `useSelector`  
**Solu√ß√£o**: Aceder diretamente `state.orm.OrganizationDefaultLabel.itemsById`

### Bug 6: API URLs - Duplicado `/api/`
**Problema**: `socket.js` j√° adiciona `/api`, URLs ficavam `/api/api/...`  
**Solu√ß√£o**: Remover `/api/` de todas as URLs em `api/organization-default-labels.js`

### Bug 7: Pol√≠ticas - Conflito de configura√ß√£o
**Problema**: Policy espec√≠fica causava problemas de routing  
**Solu√ß√£o**: Remover policy espec√≠fica, usar default `'*': 'is-authenticated'` + check interno

### Bug 8: Controllers - Ficheiro `index.js` aggregator
**Problema**: Sails.js interpretava `index.js` como controller principal  
**Solu√ß√£o**: Eliminar `index.js`, deixar apenas controllers individuais

### Bug 9: Sagas - Faltava wrapper `request`
**Problema**: Sagas chamavam `api.*` diretamente, sem Authorization header  
**Solu√ß√£o**: Todas as sagas agora usam `yield call(request, api.*)`

### Bug 10: API - Fun√ß√µes n√£o aceitavam `headers`
**Problema**: Fun√ß√µes API n√£o tinham par√¢metro `headers`, token n√£o era enviado  
**Solu√ß√£o**: Todas as fun√ß√µes API agora aceitam `headers` como √∫ltimo par√¢metro

### Bug 11: Selector - Warning de memoization
**Problema**: Selector retornava novo array a cada render  
**Solu√ß√£o**: Separar em `useSelector` (para itemsById) + `useMemo` (para array ordenado)

---

## üìã Pr√≥ximos Passos

### Fase 2: UI Completa (CRUD)
1. **Componente de Item de Label**
   - Mostrar nome, cor, descri√ß√£o
   - Bot√µes de editar e eliminar
   - Drag-and-drop para reordena√ß√£o

2. **Modal de Cria√ß√£o/Edi√ß√£o**
   - Formul√°rio com nome, cor (color picker), descri√ß√£o
   - Valida√ß√£o de nome √∫nico
   - Preview da label

3. **A√ß√µes em Lote**
   - Seletor de projetos
   - Escolha de modo de overwrite
   - Progress indicator
   - Relat√≥rio de resultados

### Fase 3: Features Avan√ßadas
1. **Aplica√ß√£o Autom√°tica**
   - Confirmar que funciona ao criar novos boards
   - Testes em diferentes cen√°rios

2. **WebSocket Real-time Updates**
   - Implementar handlers de socket para opera√ß√µes CRUD
   - Sincronizar estado entre m√∫ltiplos clientes

3. **Feature Flag**
   - Adicionar vari√°vel de ambiente `PLANKA_FEATURE_ORG_DEFAULT_LABELS`
   - Condicionar toda a funcionalidade √† flag

4. **Testes**
   - Testes de integra√ß√£o backend
   - Testes de componentes frontend
   - Testes E2E

---

## üéì Li√ß√µes Aprendidas

### 1. Padr√µes de Autentica√ß√£o no Planka
- O wrapper `request` em `client/src/sagas/core/request.js` √© **ESSENCIAL**
- Injeta `Authorization: Bearer ${token}` em todos os pedidos
- Lida com UNAUTHORIZED fazendo logout autom√°tico

### 2. Estrutura de API no Planka
- Fun√ß√µes API devem **SEMPRE** aceitar `headers` como √∫ltimo par√¢metro
- `socket.get(url, data, headers)` - data pode ser `undefined`
- `socket.post/patch/delete(url, data, headers)` - seguem o mesmo padr√£o

### 3. Controllers Sails.js
- **N√ÉO** criar ficheiros `index.js` em diret√≥rios de controllers
- Sails.js interpreta como controller principal e quebra routing
- Usar apenas controllers individuais com fun√ß√µes standalone

### 4. Policies Sails.js
- Pol√≠tica `'*': 'is-authenticated'` √© suficiente para maioria dos casos
- Checks adicionais (admin, project owner) devem ser **dentro** dos controllers
- Evitar policies espec√≠ficas por controller exceto casos especiais

### 5. Redux-ORM
- N√£o usar m√©todos como `.all()` diretamente em selectors
- Aceder `state.orm.ModelName.itemsById` e processar manualmente
- Usar `useMemo` para transforma√ß√µes complexas e evitar re-renders

### 6. Debugging Sails.js
- Logs do servidor mostram se request chegou
- Se n√£o h√° logs, problema est√° no routing/policies
- `docker logs boards-server --tail 50` √© o melhor amigo

---

## üì¶ Estrutura de Ficheiros Criados/Modificados

```
server/
‚îú‚îÄ‚îÄ db/migrations/
‚îÇ   ‚îî‚îÄ‚îÄ 20251002000000_add_organization_default_labels.js ‚ú® NOVO
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OrganizationDefaultLabel.js ‚ú® NOVO
‚îÇ   ‚îú‚îÄ‚îÄ hooks/query-methods/models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OrganizationDefaultLabel.js ‚ú® NOVO
‚îÇ   ‚îú‚îÄ‚îÄ controllers/organization-default-labels/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ list.js ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create.js ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ update.js ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ delete.js ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reorder.js ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bulk-apply.js ‚ú® NOVO
‚îÇ   ‚îî‚îÄ‚îÄ helpers/
‚îÇ       ‚îú‚îÄ‚îÄ organization-default-labels/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ apply-to-boards.js ‚ú® NOVO
‚îÇ       ‚îî‚îÄ‚îÄ boards/
‚îÇ           ‚îî‚îÄ‚îÄ create-one.js üìù MODIFICADO
‚îî‚îÄ‚îÄ config/
    ‚îú‚îÄ‚îÄ routes.js üìù MODIFICADO
    ‚îî‚îÄ‚îÄ policies.js üìù MODIFICADO (depois revertido)

client/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ActionTypes.js üìù MODIFICADO
‚îÇ   ‚îú‚îÄ‚îÄ actions/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ organization-default-labels.js ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js üìù MODIFICADO
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ organization-default-labels.js ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js üìù MODIFICADO
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OrganizationDefaultLabel.js ‚ú® NOVO
‚îÇ   ‚îú‚îÄ‚îÄ sagas/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ organization-default-labels.js ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ core/watchers/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.js üìù MODIFICADO
‚îÇ   ‚îú‚îÄ‚îÄ orm.js üìù MODIFICADO
‚îÇ   ‚îú‚îÄ‚îÄ components/common/AdministrationModal/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DefaultLabelsPane/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DefaultLabelsPane.jsx ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DefaultLabelsPane.module.scss ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AdministrationModal.jsx üìù MODIFICADO
‚îÇ   ‚îî‚îÄ‚îÄ locales/
‚îÇ       ‚îú‚îÄ‚îÄ pt-PT/core.js üìù MODIFICADO
‚îÇ       ‚îî‚îÄ‚îÄ en-US/core.js üìù MODIFICADO
```

---

## üöÄ Como Testar

1. **Verificar Seeds**:
   ```bash
   docker exec -it boards-db psql -U planka -d planka -c "SELECT id, name, color, position FROM organization_default_label ORDER BY position;"
   ```

2. **Testar UI**:
   - Login como admin/project owner
   - Ir para Administra√ß√£o ‚Üí Etiquetas Padr√£o
   - Deve mostrar 5 labels (4 seeds + 1 teste)

3. **Testar Cria√ß√£o Autom√°tica**:
   - Criar novo projeto
   - Criar novo board no projeto
   - Verificar que board tem as default labels

4. **Testar API** (via curl/Postman):
   ```bash
   # GET - Lista labels
   curl -H "Authorization: Bearer TOKEN" http://localhost:1337/api/organization-default-labels
   
   # POST - Cria label
   curl -X POST -H "Authorization: Bearer TOKEN" -H "Content-Type: application/json" \
     -d '{"name":"Urgente","color":"red","description":"Item urgente"}' \
     http://localhost:1337/api/organization-default-labels
   ```

---

## ‚úÖ Checklist de Conclus√£o Fase 1

- [x] Migration criada e testada
- [x] Model definido com valida√ß√µes
- [x] Query methods implementados
- [x] Controllers CRUD completos
- [x] Helper de bulk apply implementado
- [x] Hook de cria√ß√£o de board modificado
- [x] Routes configuradas
- [x] Action types definidos
- [x] Actions criadas
- [x] API client implementado
- [x] Redux-ORM model criado
- [x] Sagas implementadas
- [x] UI b√°sica (lista) implementada
- [x] Estilos liquid glass aplicados
- [x] Tradu√ß√µes pt-PT e en-US
- [x] Todos os bugs corrigidos
- [x] Testado em ambiente de desenvolvimento

---

**Autor**: Claude (AI Assistant)  
**Revis√£o**: Andr√© Garcia  
**Pr√≥xima Fase**: UI Completa com CRUD Interativo

